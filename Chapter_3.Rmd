---
title: "Chapter 3: Cluster Sampling"
author: "Adam Peterson"
date: "12/19/2021"
output: 
  html_document:
    toc: true
    toc_float: true
bibliography: surveybib.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      warning = FALSE,
                      message = FALSE)
library(haven)
library(gt)
library(tidyverse)
library(survey)
library(srvyr)
data(api)
```


## Why Clusters? The NHANES design

Why sample clusters? Because sometimes it's easier than sampling individuals.
Specifically, in cases where the *cost* of sampling individuals can be quite high
sampling clusters can be more efficient, in spite of the fact that within 
cluster correlation tends to be positive, reducing the information in the 
sample. Lumley uses the NHANES survey to motivate this idea: moving 
mobile examination centers all across the country to sample individuals 
is extremely expensive. By sampling a large number of individuals within 
a census tract aggregation area the NHANES survey is able to reduce the 
cost of their effort at a reasonable expense in precision.

## Single-stage and multistage designs

Depending on the type of clusters involved it can be easy to sample the entire
cluster as classrooms, medical practice and workplaces are, however it is more 
likely that some subsampling within clusters will be performed for the sake of
efficiency. As Lumley notes, clusters in the first stage are called 
*Primary Sampling Units* or PSUs.

Sampling weights are determined assuming independence --- e.g. if a 
cluster of houses is sampled with probability $\pi_1$ and a household 
is sampled within that cluster with probability $\pi_2$ then the 
sampling probability for that house is $\pi = \pi_1 \times \pi_2$ and 
it's weight is the inverse of that probability.

Lumley goes on to describe how cluster sampling and individual sampling can be 
mixed since each stratum of a survey can be thought of as a separate and 
independent sample it is trivial to combine single stage sampling in one 
stratum and multistage sampling in another; a stratified random sample can be 
used in high density regions and a cluster sample can be taken in low density 
regions. 


## Describing Multi Stage Designs in R

In order to specify a single stage cluster sample or a multistage sample treated 
as a single stage sample with replacement, the main difference is that the 
PSU identifier needs to be supplied to the `id` argument, as follows.

```{r}
data(nhanes3)
svydesign(id = ~ SDPPSU6, strat = ~SDPSTRA6,
          weight = ~WTPFHX6, 
          ## nest = TRUE indicates the PSU identifier is nested
          ## within stratum
          nest = TRUE,  
          data = nhanes3)
```
In a multistage sample that uses information about finite population sizes, the
`id`, `strata` and `fpc` arguments each specify a variable for each stage of
sampling.

For example, a two stage design for the API population that samples 40 school 
districts, then five schools within each district , the design has population 
size 757 at the first stage for the number of school districts in CA and 
the number of schools within each district for the second stage.
The weights need not be supplied if they can be worked out from the 
other arguments.

```{r}
as_tibble(apiclus2)
```

```{r}
## dnum = district id
## snum = school id
## fpc1 = school id number
clus2_design <- svydesign(id=~dnum+snum,fpc = ~fpc1+fpc2,data = apiclus2)
clus2_design
```

## Strata with only one PSU

##  Sampling by Size


```{r}
data(election)
election <- as_tibble(election) %>% 
    mutate(votes = Bush + Kerry + Nader,
           p = 40 * votes / sum(votes))
election
library(sampling)
insample <- UPtille(election$p)
ppsample <- election[insample == 1, ]
ppsample$wt <- 1 / ppsample$p
pps_design <- svydesign(id =  ~ 1, weight = ~ wt, data = ppsample)
```

```{r}
svytotal(~Bush + Kerry + Nader, pps_design, deff = TRUE)
```

## References